# -*- coding: utf-8 -*-
from bs4 import BeautifulSoup as bs

from intelmq.lib import utils
from intelmq.lib.bot import ParserBot


class MalwareurlParserBot(ParserBot):
    def process(self):
        report = self.receive_message()
        raw_report = utils.base64_decode(report["raw"])

        soup = bs(raw_report, 'html.parser')
        table = soup.find_all('table')[11]
        fqdns = table.find_all(attrs={"size": "35"})
        ips = table.find_all(attrs={"size": "12"})
        rows = table.find_all('tr')[1:]

        for fqdn, ip, row in zip(fqdns, ips, rows):
            event = self.new_event(report)
            event.add("source.fqdn", fqdn['value'], raise_failure=False)
            event.add("source.ip", ip['value'])
            event.add("classification.type", "malware")
            event.add("raw", row)
            self.send_message(event)
        self.acknowledge_message()


BOT = MalwareurlParserBot
