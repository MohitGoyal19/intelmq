# -*- coding: utf-8 -*-
import os
import unittest

import intelmq.lib.test as test
from intelmq.bots.parsers.malwareurl2.parser import MalwareurlParserBot
from intelmq.lib import utils

with open(os.path.join(os.path.dirname(__file__), 'test_malwareurl.data')) as handle:
    REPORT_DATA = handle.read()
    REPORT_DATA_SPLIT = REPORT_DATA.splitlines()


REPORT = {"__type": "Report",
          "feed.name": "Malware url",
          "feed.url": "http://www.malwareurl.com",
          "raw": utils.base64_encode(REPORT_DATA),
          "time.observation": "2018-01-22T14:38:24+00:00"
          }
EVENT1 = {"feed.url": "http://www.malwareurl.com",
          "time.observation": "2018-01-22T14:38:24+00:00",
          "raw": "Wyc8aW5wdXQgdHlwZT0idGV4dCIgdmFsdWU9InN1cm1hYWlyLmNvbSIgc2l6ZT0iMzUiIHN0eWxlPSJib3JkZXI6bm9uZ"
                 "TsgaGVpZ2h0OjE1IiddWyc8aW5wdXQgdHlwZT0idGV4dCIgdmFsdWU9IjYzLjE0My4zMy4xMjIiIHNpemU9IjEyIiBzdH"
                 "lsZT0iYm9yZGVyOm5vbmU7IGhlaWdodDoxNSInXQ==",
          "source.fqdn": "surmaair.com",
          "feed.name": "Malware url",
          "classification.type": "malware",
          "__type": "Event",
          "source.ip": "63.143.33.122"}
EVENT2 = {"__type": "Event",
          "feed.name": "Malware url",
          "classification.type": "malware",
          "raw": "Wyc8aW5wdXQgdHlwZT0idGV4dCIgdmFsdWU9ImFsYWluaG9zLmNvbSIgc2l6ZT0iMzUiIHN0eWxlPSJib3JkZXI6bm9uZTsg"
                 "aGVpZ2h0OjE1IiddWyc8aW5wdXQgdHlwZT0idGV4dCIgdmFsdWU9IjYzLjE0My4zMy4xMjIiIHNpemU9IjEyIiBzdHlsZT0i"
                 "Ym9yZGVyOm5vbmU7IGhlaWdodDoxNSInXQ==",
          "source.fqdn": "alainhos.com",
          "time.observation": "2018-01-22T14:38:24+00:00",
          "feed.url": "http://www.malwareurl.com",
          "source.ip": "63.143.33.122"}


class TestMalwareurlParserBot(test.BotTestCase, unittest.TestCase):

    @classmethod
    def set_bot(cls):
        cls.bot_reference = MalwareurlParserBot
        cls.default_input_message = REPORT

    def test_event(self):
        self.run_bot()
        self.assertMessageEqual(0, EVENT1)
        self.assertMessageEqual(1, EVENT2)


if __name__ == '__main__':
    unittest.main()
